name: Deploy and Notify

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number for manual deployment'
        required: true
        type: string

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get release information
        id: release_info
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
            
            # Handle multi-line body properly
            BODY=$(echo "${{ github.event.release.body }}" | head -c 500 | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
            echo "body=$BODY" >> $GITHUB_OUTPUT
            
            echo "url=${{ github.event.release.html_url }}" >> $GITHUB_OUTPUT
            echo "name=${{ github.event.release.name }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "body=Manual deployment triggered" >> $GITHUB_OUTPUT
            echo "url=${{ github.server_url }}/${{ github.repository }}" >> $GITHUB_OUTPUT
            echo "name=RND ${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # Create RGX Mods standard Discord message
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"content\": \"\",
                 \"username\": \"RND Update\",
                 \"avatar_url\": \"https://raw.githubusercontent.com/donniedice/SimpleQuestPlates/main/images/kiwi.gif\",
                 \"embeds\": [{
                   \"title\": \"üõ°Ô∏è RND | Removed Nameplate Debuffs - ${{ steps.release_info.outputs.version }}\",
                   \"description\": \"**Clean Nameplates, Clear Focus!** - A new version of RND has been released!\\n\\n‚ú® **What's New:**\\n‚Ä¢ Check the release notes for full details\\n‚Ä¢ Bug fixes and performance improvements\\n\\n**Remove debuff clutter from enemy nameplates for a cleaner UI experience!**\",
                   \"url\": \"${{ steps.release_info.outputs.url }}\",
                   \"color\": 10699549,
                   \"fields\": [
                     {
                       \"name\": \"üì• Downloads\",
                       \"value\": \"[CurseForge](https://www.curseforge.com/wow/addons/remove-nameplate-debuffs)\\n[Wago.io](https://addons.wago.io/addons/rnd)\\n[GitHub](https://github.com/donniedice/remove_nameplate_debuffs)\",
                       \"inline\": true
                     },
                     {
                       \"name\": \"üéÆ Compatibility\",
                       \"value\": \"‚úÖ The War Within\\n‚úÖ Classic Era\\n‚úÖ Cataclysm\\n‚úÖ MoP\\n‚úÖ WotLK\\n‚úÖ TBC\",
                       \"inline\": true
                     },
                     {
                       \"name\": \"üí¨ Support\",
                       \"value\": \"[Join Discord](https://discord.gg/hK9N3esnce)\\n[Report Issues](https://github.com/donniedice/remove_nameplate_debuffs/issues)\",
                       \"inline\": true
                     }
                   ],
                   \"footer\": {
                     \"text\": \"RGX Mods - RealmGX Community\",
                     \"icon_url\": \"https://raw.githubusercontent.com/donniedice/SimpleQuestPlates/main/images/kiwi.gif\"
                   },
                   \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
                 }]
               }" \
               "$DISCORD_WEBHOOK"
      
      - name: Deploy to CurseForge
        if: github.event_name == 'release'
        env:
          CURSEFORGE_API_TOKEN: ${{ secrets.CURSEFORGE_API_TOKEN }}
        run: |
          echo "CurseForge deployment would happen here"
          echo "This step requires the CurseForge API token to be configured"
          # Add actual CurseForge deployment logic here when API token is available
      
      - name: Deploy to Wago
        if: github.event_name == 'release'
        env:
          WAGO_API_TOKEN: ${{ secrets.WAGO_API_TOKEN }}
        run: |
          echo "Wago deployment would happen here"
          echo "This step requires the Wago API token to be configured"
          # Add actual Wago deployment logic here when API token is available